# 筛选互斥功能说明

## 功能描述

颜色筛选和标签筛选现在是**互斥**的，同一时间只能使用一种筛选方式。

## 使用行为

### 场景 1：从无筛选状态开始

#### 点击颜色筛选
```
操作：点击红色颜色按钮
结果：
  ✅ 只显示红色标记的书签
  ✅ 红色按钮高亮
  ❌ 所有标签按钮不高亮
```

#### 点击标签筛选
```
操作：点击"工作"标签
结果：
  ✅ 只显示带有"工作"标签的书签
  ✅ "工作"标签高亮
  ❌ 所有颜色按钮不高亮
```

### 场景 2：已有颜色筛选

```
当前状态：红色筛选激活
操作：点击"工作"标签
结果：
  ✅ 显示带有"工作"标签的书签（包括所有颜色）
  ✅ "工作"标签高亮
  ❌ 红色按钮不再高亮
  📝 颜色筛选被自动清除
```

### 场景 3：已有标签筛选

```
当前状态："工作"标签筛选激活
操作：点击蓝色颜色按钮
结果：
  ✅ 显示蓝色标记的书签（包括所有标签）
  ✅ 蓝色按钮高亮
  ❌ "工作"标签不再高亮
  📝 标签筛选被自动清除
```

### 场景 4：多标签筛选

```
当前状态："工作" + "重要" 标签筛选激活
操作：点击任意颜色按钮
结果：
  ✅ 显示该颜色的书签
  ✅ 该颜色按钮高亮
  ❌ 所有标签（"工作"和"重要"）都不再高亮
  📝 所有标签筛选被清除
```

### 场景 5：取消筛选

#### 取消颜色筛选
```
操作：再次点击已激活的颜色按钮
结果：
  ✅ 显示所有书签
  ❌ 该颜色按钮不再高亮
  ℹ️ 标签筛选保持清除状态
```

#### 取消标签筛选
```
操作：再次点击已激活的标签
结果：
  ✅ 如果没有其他标签筛选，显示所有书签
  ✅ 如果还有其他标签筛选，继续按剩余标签筛选
  ❌ 该标签不再高亮
  ℹ️ 颜色筛选保持清除状态
```

## 技术实现

### 修改的函数

#### 1. `toggleTagFilterFromBookmark()` - 标签筛选

**位置**：`src/pages/sidepanel/sidepanel.js` 第 597-628 行

**修改内容**：
```javascript
// 新增：标签筛选激活时，清除颜色筛选
if (currentTagFilters.length > 0) {
  currentColorFilter = '';
  updateColorFilterState();
}
```

**逻辑**：
- 当添加任何标签筛选时
- 自动清除 `currentColorFilter`
- 调用 `updateColorFilterState()` 更新颜色按钮 UI
- **多标签使用 OR 逻辑**：书签包含任一选中标签即可显示

#### 2. `applyFilters()` - 筛选逻辑

**位置**：`src/pages/sidepanel/sidepanel.js` 第 205-242 行

**标签筛选逻辑**：
```javascript
// 使用 OR 逻辑：书签包含任一选中的标签即可
const hasAnyTag = requiredTags.length > 0 && 
  requiredTags.some(tag => bookmarkTags.includes(tag));
```

**说明**：
- 多标签筛选使用 **OR 逻辑**
- 书签只需包含任一选中的标签即可显示
- 例如：选择"工作"和"重要"标签，显示所有带"工作"**或**"重要"标签的书签

#### 3. `initColorFilters()` - 颜色筛选

**位置**：`src/pages/sidepanel/sidepanel.js` 第 854-872 行

**修改内容**：
```javascript
if (currentColorFilter === color) {
  currentColorFilter = '';
} else {
  currentColorFilter = color;
  // 新增：颜色筛选激活时，清除标签筛选
  currentTagFilters = [];
  updateTagChipState();
}
```

**逻辑**：
- 当激活任何颜色筛选时（非取消操作）
- 清空 `currentTagFilters` 数组
- 调用 `updateTagChipState()` 更新标签按钮 UI

## 用户体验优势

### ✅ 优点

1. **逻辑清晰**
   - 一次只用一种筛选方式
   - 避免复杂的组合筛选逻辑
   - 用户更容易理解当前筛选状态

2. **操作简单**
   - 不需要手动清除之前的筛选
   - 点击新筛选自动切换
   - 减少操作步骤

3. **视觉明确**
   - UI 状态一目了然
   - 只有一种类型的按钮高亮
   - 降低认知负担

4. **性能更好**
   - 减少同时判断两种筛选条件
   - 简化筛选逻辑
   - 提升响应速度

### ⚠️ 权衡

1. **灵活性降低**
   - 不能同时按颜色和标签筛选
   - 例如：不能筛选"红色 + 工作标签"

2. **需求变化**
   - 如果用户确实需要组合筛选
   - 可能需要考虑其他方案（如高级筛选模式）

## 替代方案（如果需要组合筛选）

如果将来需要支持组合筛选，可以考虑：

### 方案 1：增加"高级筛选"模式
```
[基础模式] ←→ [高级模式]

基础模式：颜色和标签互斥（当前实现）
高级模式：可以同时使用多种筛选
```

### 方案 2：筛选条件面板
```
┌─────────────────────┐
│ 筛选条件：          │
│ ☑ 颜色：红色        │
│ ☑ 标签：工作、重要  │
│ [清除全部] [应用]   │
└─────────────────────┘
```

### 方案 3：搜索语法
```
搜索框支持特殊语法：
color:red tag:工作 tag:重要
```

## 测试建议

### 测试用例

1. **基础互斥测试**
   - [ ] 选择颜色 → 选择标签 → 验证颜色被清除
   - [ ] 选择标签 → 选择颜色 → 验证标签被清除

2. **多标签测试**
   - [ ] 选择标签 A → 选择标签 B → 选择颜色 → 验证 A 和 B 都被清除

3. **取消操作测试**
   - [ ] 选择颜色 → 取消颜色 → 验证显示所有书签
   - [ ] 选择标签 → 取消标签 → 验证显示所有书签

4. **UI 状态测试**
   - [ ] 验证按钮高亮状态正确
   - [ ] 验证标签芯片状态正确
   - [ ] 验证颜色按钮状态正确

5. **与搜索结合测试**
   - [ ] 搜索 + 颜色筛选 → 结果正确
   - [ ] 搜索 + 标签筛选 → 结果正确
   - [ ] 搜索 + 颜色 → 切换标签 → 结果正确

## 向后兼容

✅ 完全兼容：
- 不影响现有数据
- 不需要迁移
- 只是行为变化，不是破坏性更改

## 相关文件

- `src/pages/sidepanel/sidepanel.js` - 主要筛选逻辑
- `src/pages/sidepanel/sidepanel.html` - 颜色和标签 UI
- `src/pages/sidepanel/sidepanel.css` - 按钮高亮样式

## 总结

实现了颜色筛选和标签筛选的互斥逻辑：
- ✅ 点击颜色时清除标签筛选
- ✅ 点击标签时清除颜色筛选
- ✅ UI 状态自动同步
- ✅ 用户体验更清晰简洁

---

**更新日期**: 2025-01-14  
**版本**: v2.0.2  
**影响**: 筛选行为变化（非破坏性）
